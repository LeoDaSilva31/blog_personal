{% extends 'propiedades/propiedades_base.html' %}
{% load static %}
{% load humanize l10n %}

{% block title %}Búsqueda de Propiedades{% endblock %}

{% block content %}
  <!-- Encabezado -->
  <div class="mb-6">
    <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">Búsqueda avanzada</h1>
    <p class="mt-1 text-sm text-gray-600">Combiná filtros y encontrá tu próxima propiedad.</p>
  </div>

  <!-- Panel filtros -->
  <div class="panel">
    <form id="form-busqueda" method="get" class="space-y-5">
      <!-- fila 1: texto + precio + toggle moneda -->
      <div class="flex flex-col gap-3 lg:flex-row lg:items-center">
        <div class="flex-1">
          <label for="q" class="sr-only">Buscar</label>
          <input type="search" id="q" name="q" value="{{ val.q|default:'' }}"
                 placeholder="Buscar por título, dirección, localidad o provincia…"
                 class="input w-full focus-ring" />
        </div>

        <div class="flex items-center gap-3">
          <!-- Toggle Moneda -->
          <input type="hidden" id="currency" name="currency" value="{{ val.currency|default:'ars' }}">
          <button type="button" id="currencyToggle"
                  class="btn {% if val.currency == 'usd' %}btn-primary{% else %}btn-secondary{% endif %}"
                  aria-pressed="{% if val.currency == 'usd' %}true{% else %}false{% endif %}">
            {% if val.currency == 'usd' %}USD{% else %}ARS{% endif %}
          </button>

          <!-- Rango de precio -->
          <div class="flex items-center gap-2">
            <label for="price_min" class="sr-only">Precio mín</label>
            <input type="number" id="price_min" name="price_min" step="1" min="0"
                   value="{{ val.price_min|default:'' }}" placeholder="mín"
                   class="input input-sm w-24">
            <span class="text-gray-400">–</span>
            <label for="price_max" class="sr-only">Precio máx</label>
            <input type="number" id="price_max" name="price_max" step="1" min="0"
                   value="{{ val.price_max|default:'' }}" placeholder="máx"
                   class="input input-sm w-24">
          </div>
        </div>
      </div>

      <div class="soft-divider"></div>

      <!-- fila 2: selects -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Tipo -->
        <div>
          <label for="tipo" class="block text-xs font-semibold text-gray-700 mb-1">Tipo</label>
          <select id="tipo" name="tipo" class="select w-full">
            <option value="">Todos</option>
            {% for key,label in propiedad.TIPO_PROPIEDAD_CHOICES %}
              <option value="{{ key }}" {% if val.tipo == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Operación -->
        <div>
          <label for="tipo_operacion" class="block text-xs font-semibold text-gray-700 mb-1">Operación</label>
          <select id="tipo_operacion" name="tipo_operacion" class="select w-full">
            <option value="">Todas</option>
            {% for key,label in propiedad.TIPO_OPERACION_CHOICES %}
              <option value="{{ key }}" {% if val.tipo_operacion == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Localidad -->
        <div>
          <label for="localidad" class="block text-xs font-semibold text-gray-700 mb-1">Localidad</label>
          <input id="localidad" name="localidad" class="input w-full" value="{{ val.localidad|default:'' }}" placeholder="Ej: Quilmes">
        </div>

        <!-- Provincia -->
        <div>
          <label for="provincia" class="block text-xs font-semibold text-gray-700 mb-1">Provincia</label>
          <input id="provincia" name="provincia" class="input w-full" value="{{ val.provincia|default:'' }}" placeholder="Ej: Buenos Aires">
        </div>
      </div>

      <!-- botón “Más filtros” visible solo en móvil -->
      <div class="md:hidden">
        <button type="button" id="toggleAdvanced"
                class="btn btn-secondary w-full justify-center"
                aria-expanded="false" aria-controls="advancedFilters">
          Más filtros
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
      </div>

      <!-- fila 3: numéricos (oculto en móvil por defecto, visible siempre en md+) -->
      <div id="advancedFilters"
           class="hidden md:grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label for="dormitorios" class="block text-xs font-semibold text-gray-700 mb-1">Dormitorios</label>
          <input type="number" id="dormitorios" name="dormitorios" min="0"
                 value="{{ val.dormitorios|default:'' }}" class="input w-full">
        </div>
        <div>
          <label for="banios" class="block text-xs font-semibold text-gray-700 mb-1">Baños</label>
          <input type="number" id="banios" name="banios" min="0"
                 value="{{ val.banios|default:'' }}" class="input w-full">
        </div>
        <div>
          <label for="cocheras" class="block text-xs font-semibold text-gray-700 mb-1">Cocheras</label>
          <input type="number" id="cocheras" name="cocheras" min="0"
                 value="{{ val.cocheras|default:'' }}" class="input w-full">
        </div>
      </div>

      <!-- acciones -->
      <div class="flex items-center gap-3 pt-1">
        <button class="btn btn-primary" type="submit">Buscar</button>
        <a class="btn btn-secondary" href="{% url 'propiedades:busqueda' %}">Limpiar</a>
      </div>
    </form>
  </div>

  <!-- Chips activos -->
  {% if chips %}
    <div class="chips mt-4">
      {% for c in chips %}
        <a class="chip focus-ring" href="{{ c.remove_url }}">{{ c.label }}</a>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Resultados -->
  {% if show_results %}
    <div class="mt-6 container-wide">
      <div class="grid items-stretch grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
        {% for prop in propiedades %}
          {% include 'propiedades/_card.html' with prop=prop %}
        {% empty %}
          <!-- Si no hay resultados para los filtros -->
          <div class="col-span-full">
            <div class="panel panel-muted">
              <p class="text-gray-600">No se encontraron resultados con los filtros actuales.</p>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
        <nav class="mt-8 flex items-center justify-center gap-2 text-sm">
          {% if page_obj.has_previous %}
            <a class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50"
               href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
          {% endif %}

          <span class="px-3 py-1.5 rounded-lg border border-gray-200 bg-gray-50">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50"
               href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
          {% endif %}
        </nav>
      {% endif %}
    </div>
  {% else %}
    <!-- Mensaje inicial (sin filtros aún) -->
    <div class="mt-6 panel panel-muted">
      <p class="text-gray-600">Usá los filtros de arriba para iniciar la búsqueda.</p>
    </div>
  {% endif %}

  <!-- Script: toggle moneda + “Más filtros” móvil -->
  <script>
    (function(){
      // Toggle moneda
      const btn = document.getElementById('currencyToggle');
      const input = document.getElementById('currency');
      if (btn && input) {
        btn.addEventListener('click', () => {
          const usd = input.value === 'usd';
          input.value = usd ? 'ars' : 'usd';
          btn.setAttribute('aria-pressed', usd ? 'false' : 'true');
          btn.classList.toggle('btn-primary', !usd);
          btn.classList.toggle('btn-secondary', usd);
          btn.textContent = usd ? 'ARS' : 'USD';
        });
      }

      // “Más filtros” en móvil
      const advBtn = document.getElementById('toggleAdvanced');
      const adv = document.getElementById('advancedFilters');
      const isDesktop = () => window.matchMedia('(min-width: 768px)').matches; // md

      function setBtnLabel(open){
        if (!advBtn) return;
        const txtNode = advBtn.childNodes[0];
        if (txtNode && txtNode.nodeType === Node.TEXT_NODE) {
          txtNode.textContent = open ? 'Menos filtros ' : 'Más filtros ';
        }
      }

      function openAdvanced() {
        if (!adv) return;
        adv.classList.remove('hidden');
        advBtn && advBtn.setAttribute('aria-expanded', 'true');
        setBtnLabel(true);
      }
      function closeAdvanced() {
        if (!adv) return;
        if (!isDesktop()) { // en desktop nunca ocultamos
          adv.classList.add('hidden');
          advBtn && advBtn.setAttribute('aria-expanded', 'false');
          setBtnLabel(false);
        }
      }

      if (advBtn && adv) {
        const hasValues = !!(
          (document.getElementById('dormitorios')?.value) ||
          (document.getElementById('banios')?.value) ||
          (document.getElementById('cocheras')?.value)
        );
        if (hasValues && !isDesktop()) openAdvanced();

        advBtn.addEventListener('click', () => {
          const hidden = adv.classList.contains('hidden');
          hidden ? openAdvanced() : closeAdvanced();
        });

        window.addEventListener('resize', () => {
          if (isDesktop()) {
            adv.classList.remove('hidden');
            advBtn && advBtn.setAttribute('aria-expanded', 'true');
            setBtnLabel(true);
          } else if (!hasValues) {
            adv.classList.add('hidden');
            advBtn && advBtn.setAttribute('aria-expanded', 'false');
            setBtnLabel(false);
          }
        });
      }
    })();
  </script>
{% endblock %}
